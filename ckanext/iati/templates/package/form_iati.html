<form id="package-edit" class="package_create_form ckan" method="post"
    py:attrs="{'class':'has-errors'} if errors else {}"
    xmlns:i18n="http://genshi.edgewall.org/i18n"
    xmlns:py="http://genshi.edgewall.org/"
    xmlns:xi="http://www.w3.org/2001/XInclude">

    <div class="error-explanation" py:if="error_summary">
        <h2>Errors in form</h2>
        <p>The form contains invalid entries:</p>
        <ul>
            <li py:for="key, error in error_summary.items()">${"%s: %s" % (key, error)}</li>
        </ul>
    </div>

    <fieldset>
        <legend>Basic information </legend>
        <dl>
            <dt><label class="field_req" for="name">Name *</label></dt>
            <dd><input id="name" maxlength="100" name="name" type="text" value="${data.get('name', '')}" /></dd>
            <dd class="field_error" py:if="errors.get('name', '')">${errors.get('name', '')}</dd>
            <dd class="instructions basic">A unique identifier for the activity record.</dd>
            <dd class="instructions further">It should be broadly humanly readable, in the spirit of Semantic Web URIs. Only use an acronym if it is widely recognised. Renaming is possible but discouraged.</dd>
            <dd class="hints">2+ characters, lowercase, using only 'a-z0-9' and '-_'</dd>
            <script type="text/javascript">
                //<![CDATA[
                $(document).ready(function () { if (!$('#preview').length) {$("#name").focus(); } });
                //]]>
            </script>

            <dt><label class="field_opt" for="title">Title </label></dt>
            <dd><input id="title" name="title" type="text" value="${data.get('title', '')}" /></dd>
            <dd class="field_error" py:if="errors.get('title', '')">${errors.get('title', '')}</dd>
            <dd class="instructions basic">A short descriptive title for the data set.</dd>
            <dd class="instructions further">It should not be a description though - save that for the Notes field. Do not give a trailing full stop.</dd>

            <dt><label class="field_opt" for="author">Contact</label></dt>
            <dd><input id="author" name="author" type="text" value="${data.get('author', '')}" /></dd>
            <dd class="instructions basic">The name of the main contact, for enquiries about this particular dataset, using the e-mail address in the following field.</dd>

            <dt><label class="field_opt" for="author_email">Contact e-mail</label></dt>
            <dd><input id="author_email" name="author_email" type="text" value="${data.get('author_email', '')}" /></dd>

            <dt><label class="field_opt" for="department">Department</label></dt>
            <dd><input id="department" name="department" size="40" type="text" value="${data.get('department', '')}" /></dd>
        </dl>
    </fieldset>

    <fieldset id="groups">
        <legend>Publisher</legend>
        <dl>
        <py:for each="num, group in enumerate(data.get('groups', []))">
            <?python
            authorized_group = [group_authz for group_authz in c.groups_authz if group_authz['id'] == group['id']]
            authorized_group = authorized_group[0] if authorized_group else None
            ?>

            <dt py:if="'id' in group">
                <input type="${'checkbox' if authorized_group else 'hidden'}" name="groups__${num}__id" checked="checked" value="${group['id']}" />
                <input type="hidden" name="groups__${num}__name" value="${group.get('name', authorized_group['name'] if authorized_group else '')}" />
            </dt>
            <dd py:if="'id' in group"><label for="groups__${num}__checked">${group.get('name', authorized_group['name'] if authorized_group else '')}</label></dd>
        </py:for>

        <dt>Publisher</dt>
            <dd py:if="c.groups_available">
            <select id="groups__${len(data.get('groups', []))}__id" name="groups__${len(data.get('groups', []))}__id">
                <dd py:if="data.get('groups',[])">
                    <option value="" >(None)</option>
                </dd>
                <py:for each="group in c.groups_available">
                    <option value="${group['id']}" >${group['title']}</option>
                </py:for>
            </select>
            </dd>
            <dd py:if="not c.groups_available">Cannot add any publisher.</dd>
        </dl>

    </fieldset>

    <fieldset>
        <legend>Details</legend>
        <dl>
            <dt><label class="field_opt" for="country">Recipient country</label></dt>
            <dd>
                <py:with vars="country = data.get('country','')">
                <select id="country" name="country">
                    <py:for each="name,id in c.countries">
                    <option value="${id}" py:attrs="{'selected': 'selected' if country == id else None}">${name}</option>
                    </py:for>
                </select>
                </py:with>
            </dd>

            <dt><label class="field_opt" for="donors">Donors</label></dt>
            <dd><input id="donors" name="donors" type="text" value="${data.get('donors', '')}" /></dd>
            <dd class="instructions basic">Separate multiple entries using commas.</dd>

            <dt><label class="field_opt" for="donors_type">Donor type</label></dt>
            <dd><input id="donors_type" name="donors_type" type="text" value="${data.get('donors_type', '')}" /></dd>
            <dd class="instructions basic">Separate multiple entries using commas.</dd>

            <dt><label class="field_opt" for="donors_country">Donor country</label></dt>
            <dd><input id="donors_country" name="donors_country" type="text" value="${data.get('donors_country', '')}" /></dd>
            <dd class="instructions basic">Separate multiple entries using commas.</dd>

            <dt><label class="field_opt" for="record_updated">Record updated</label></dt>
            <dd><input id="record_updated" name="record_updated" size="40" type="text" value="${data.get('record_updated', '')}" /></dd>
            <dd class="instructions basic">Acceptable formats: 'DD/MM/YYYY HH:MM', 'DD/MM/YYYY', 'MM/YYYY', 'YYYY'.</dd>

            <dt><label class="field_opt" for="data_updated">Data updated</label></dt>
            <dd><input id="data_updated" name="data_updated" size="40" type="text" value="${data.get('data_updated', '')}"/></dd>
            <dd class="instructions basic">Acceptable formats: 'DD/MM/YYYY HH:MM', 'DD/MM/YYYY', 'MM/YYYY', 'YYYY'.</dd>

            <dt><label class="field_opt" for="license_id">License</label></dt>
            <dd>
                <select id="license_id" name="license_id">
                    <py:for each="licence_desc, licence_id in c.licences">
                        <option value="${licence_id}" py:attrs="{'selected': 'selected' if data.get('license_id', '') == licence_id else None}" >${licence_desc}</option>
                    </py:for>
                </select>
            </dd>
            <dd class="instructions basic">The licence under which the dataset is released.</dd>

            <dt><label class="field_opt" for="tags">Tags</label></dt>
            <dd>
                <input class="autocomplete-tag" id="tag_string" name="tag_string" size="40" type="text"
                       value="${data.get('tag_string') or ' '.join([tag['name'] for tag in data.get('tags', [])])}" />
            </dd>
            <dd class="field_error" py:if="errors.get('tag_string', '')">${errors.get('tag_string', '')}</dd>
            <dd class="instructions basic">Terms that may link this dataset to similar ones. For more information on conventions, see <a href="http://wiki.okfn.org/ckan/doc/faq#TagConventions">this wiki page</a>.</dd>
            <dd class="hints">e.g. pollution rivers water-quality</dd>

            <dt><label class="field_opt" for="notes">Notes</label></dt>
            <dd><textarea cols="60" id="notes" name="notes" rows="15">${data.get('notes', '')}</textarea></dd>
            <dd class="instructions basic">The main description of the dataset</dd>
            <dd class="instructions further">It is often displayed with the record title. In particular, it should start with a short sentence that describes the data set succinctly, because the first few words alone may be used in some views of the data sets.</dd>
            <dd class="hints">You can use <a href="http://daringfireball.net/projects/markdown/syntax">Markdown formatting</a> here.</dd>
        </dl>
    </fieldset>

    <fieldset id="resources">
        <legend>Resources</legend>
        <table class="flexitable">
            <thead>
                <tr>
                    <th class="field_req resource-url">URL*</th>
                    <th class="field_opt resource-format">Format</th>
                    <th class="field_opt resource-description">Description</th>
                    <th class="field_opt resource-hash">Hash</th>
                </tr>
            </thead>
            <tbody>
                <py:for each="num, res in enumerate(data.get('resources', []) + [{}])">
                <tr>
                    <py:for each="col in c.resource_columns">
                    <td py:choose="" class="resource-${col}">
                        <input py:when="col == 'format'" name="resources__${num}__${col}" type="text" value="${res.get(col, '')}" class="autocomplete-format short" />

                        <input py:otherwise="" name="resources__${num}__${col}" type="text" value="${res.get(col, '')}" class="${'medium-width' if col == 'url' else 'short'}" />
                    </td>
                    </py:for>
                    <td class="resource-id"><input name="resources__${num}__id" type="hidden" value="${res.get('id', '')}" /></td>
                </tr>
                </py:for>
            </tbody>
        </table>

        <div class="instructions basic">The files containing the data or address of the APIs for accessing it.</div>
        <div class="instructions further"><br /><b>URL:</b> This is the Internet link directly to the data - by selecting this link in a web browser, the user will immediately download the full dataset. Note that datasets are not hosted on this site, but by the publisher of the data.<br /> <b>Format:</b> This should give the file format in which the data is supplied. (i.e. IATI-XML)<br /><b>Description</b> Any information you want to add to describe the resource.<br /></div>
        <div class="field_error" py:if="errors.get('resources', '')">Dataset resource(s) incomplete.</div>
    </fieldset>

    <fieldset>
        <legend>Verification and Analysis </legend>
        <dl>
            <dt><label class="field_opt" for="activity_period">Activitiy Period</label></dt>
            <dd>
                <input class="short" id="activity_period-from" name="activity_period-from" type="text" value="${data.get('activity_period-from', '')}" /> -
                <input class="short" id="activity_period-to" name="activity_period-to" type="text" value="${data.get('activity_period-to', '')}" />
            </dd>
            <dd class="instructions basic">Acceptable formats: 'DD/MM/YYYY HH:MM', 'DD/MM/YYYY', 'MM/YYYY', 'YYYY'.</dd>

            <dt><label class="field_opt" for="activity_count">Num. Activities</label></dt>
            <dd><input id="activity_count" name="activity_count" size="40" type="text" value="${data.get('activity_count', '')}"/></dd>

            <dt><label class="field_opt" for="archive_file">Archive</label></dt>
            <dd><input id="archive_file" name="archive_file" size="40" type="checkbox" py:attrs="{'checked': 'checked' if data.get('archive_file','') == 'yes' else None}" /></dd>
            <py:choose>
                <py:when test="c.is_sysadmin">
                <dt><label class="field_opt" for="verified">Verification</label></dt>
                <dd><input id="verified" name="verified" size="40" type="checkbox" py:attrs="{'checked': 'checked' if data.get('verified','') == 'yes' else None}" /></dd>

                <dt><label class="field_opt" for="state">State</label></dt>
                <dd>
                    <select id="state" name="state">
                        <option py:attrs="{'selected': 'selected' if data.get('state') == 'active' else None}" value="active">active</option>
                        <option py:attrs="{'selected': 'selected' if data.get('state') == 'deleted' else None}" value="deleted">deleted</option>
                        <option py:attrs="{'selected': 'selected' if data.get('state') == 'pending' else None}" value="pending">pending</option>
                    </select>
                </dd>
                </py:when>
            </py:choose>

        </dl>
    </fieldset>

    <hr />
    <label for="log_message">Edit summary (briefly describe the changes you have made)</label>
    <textarea id="log_message" name="log_message" class="short wide"></textarea>

    <div class="ckan-logged-in">
    <p>Author: ${c.author}</p>
    </div>

    <div class="submit">
    <input id="save" name="save" type="submit" value="Save" />
    </div>
    <p class="hints">
    <strong>Important:</strong> By submitting content, you agree to release your contributions
    under the open license specified on the <a href="/license">license page</a>. Please <strong>refrain</strong> from editing this page if you are <strong>not</strong> happy to do this.
    </p>

</form>
