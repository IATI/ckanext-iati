{% extends "page.html" %}
{% block title %}CSV Import Results - {{ super() }}{% endblock %}

{% block primary_content %}
<h2 class="page_heading">CSV Export</h2>
  <article>
  <div>
    <p>Your CSV upload <strong>{{file_name}}</strong> has been imported. Check the table below for progress monitoring.</p>

    <p><a href="/csv/upload">Upload another file</a></p>
  </div>
  
  {{ result }}
    <hr class="cleared" />

    <div id="result"></div>


  </article>
  {% endblock %}

  {% block scripts %}
      {{ super() }}
      <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>

      <script type="text/javascript">
        $(document).ready(function() {
        function capitalizeFirstLetter(string) {
          return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
      }

      function statusbutton(string) {
          switch (string){
             case "failed" :
                    return  '<span class="label label-danger"  data-placement="right" title="Failed">Failed</span>'
                    break ;Started
             case "finished" :
                    return '<span class="label label-success"  data-placement="right" title="Finished">Finished</span>'
                    break ;
             case "started" :
                    return '<span class="label label-info"  data-placement="right" title="Started">Started</span>'
                    break ;
             default:
                    return '<span class="label label-warning"  data-placement="right" title="'+string+'">'+capitalizeFirstLetter(string)+'</span>'
          }

      }

      function datasetLink(id,summary,warning,error) {
           if (id !== '#'){
                link = "<a target=\"_blank\" href=\"/dataset/" + id + "/\">" + summary + "</a>";
            }
            else {
                 link = summary;
            }
          if (warning){
               link = link + '<br> <p style="color:orange">Warning(s):' + warning +'</p>';
          }
          if (error){
               link = link + '<br> <p style="color:red">Error(s):' + error +'</p>';
          }

          return link;
      }

      function summaryPrint(status, task) {
          var dataset_id ="#";
          var summary_msg = "This dataset already exists.";
          if (status === "failed") {
               summary_msg = "Server Error. "
          }
          var warning_msg ="";
          var error_msg = "";
          $.each(task.result, function(key, value) {
            if (key === "added" && value.length > 0){
             dataset_id = value;
             summary_msg = 'Dataset added';
            }
            if (key === "updated" && value.length > 0){
                dataset_id = value;
                summary_msg = 'Dataset updated';
            }
            if (key === "warnings" && value.length > 0){
                if( value[0][1].file.length>0) {
                    warning_msg = value[0][1].file;
                }
            }
            if (key === "error" && value.length > 0){
             error_msg = value.join();
            }
          })
          return "<div>" + datasetLink(dataset_id,summary_msg, warning_msg, error_msg ) + "</div>"
      }

      var PollState = function(task_id) {
          $.ajax({
              url: "/csv/check_status/" + task_id,
              type: "GET",
          }).done(function(task) {
              task = JSON.parse(task);
              $("#status_" + task_id).html("<h4>" + statusbutton(task.status) + "</h4>");
             if (task.status !== "finished" && task.status !== "failed") {
                  setTimeout(PollState, 5000, task_id)
              }else{
                  $("#summary_" + task_id).html( summaryPrint(task.status, task));
              }
          }).fail(function(task){
              $("#status_" + task_id).html(statusbutton('failed'));
              $("#summary_" + task_id).html(summaryPrint('failed',task));
          });
      }
      var i;
      var all = "<table class=\"table\"> <thead> <tr> <th>Title</th> <th>Status</th>  <th>Summary</th> </tr></thead><tbody>";
      var tasks = {{tasks | safe }};
          for (i=0; i< tasks.length; i++){
           var t = JSON.parse(tasks[i]);
           all = all + "<tr><td id=dataset_"+t.task_id+">" + t.title + "</td><td id=status_"+t.task_id+"></td>"+"<td id=summary_"+t.task_id+"></td></tr>";
          }


            all = all + "</tbody>  </table>" ;
           $("#result").html(all);

          for (i=0; i< tasks.length; i++){
               var t = JSON.parse(tasks[i]);
               if (t.status === "failed"){
                   $("#status_" + t.task_id).html( statusbutton(t.status) );
                   if (t.error){
                    $("#summary_" + t.task_id).html( t.error);
                   }
               }
               else{
                   PollState(t.task_id) ;
                   }
          }
      });
      </script>
  {% endblock%}
